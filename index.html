<html>
    <head>
        <title>P2P Prolog</title>
        <link rel="icon" href="https://www.swi-prolog.org/icons/favicon.ico" />
        <script type="module">

        	import Swipl from './swipl-web.js';

            window.bindings = null;
            let stdin = '',
            		stdinPosition = 0;

            // We use this to provide data into
            // the SWI stdin.
            const setStdin = (string) => {
                stdin = string;
                stdinPosition = 0;
            };
            const readStdin = () => {
                if (stdinPosition >= stdin.length) {
                    return null;
                } else {
                    const code = stdin.charCodeAt(stdinPosition);
                    stdinPosition++;
                    return code;
                }
            };

             // Helper to print stdout from SWI.
            const print = line => console.log(line)
            const printErr = line => console.log(line)

            // Helper function to call a query.
            const callQuery = (bindings, input) => {
                // Show the query in the console output.
                /*const node = document.createTextNode(input + '\n');
                output.appendChild(node);
                */
              setStdin(input);
              // This will execute one iteration of toplevel.
              call(bindings, 'break'); // see call.js
            }
            
            // Creates bindings to the SWI foreign API.
            const createBindings = module => {
                return {
                    PL_initialise: module.cwrap('PL_initialise', 'number', ['number', 'number']),
                    PL_new_term_ref: module.cwrap('PL_new_term_ref', 'number', []),
                    PL_chars_to_term: module.cwrap('PL_chars_to_term', 'number', ['string', 'number']),
                    PL_call: module.cwrap('PL_call', 'number', ['number', 'number'])
                };
            };

            // Helper function to parse a JavaScript
            // string into a Prolog term and call it as a query.
            const call = (bindings, query) => {
                const ref = bindings.PL_new_term_ref();
                if (!bindings.PL_chars_to_term(query, ref)) {
                    throw new Error('Query has a syntax error: ' + query);
                }
                return !!bindings.PL_call(ref, 0);
            };

            const initialise = (bindings, module) => {
                const argvArray = [
                    module.allocate(module.intArrayFromString('swipl'), 'i8', module.ALLOC_NORMAL),
                    module.allocate(module.intArrayFromString('-x'), 'i8', module.ALLOC_NORMAL),
                    module.allocate(module.intArrayFromString('wasm-preload/swipl.prc'), 'i8', module.ALLOC_NORMAL),
                    module.allocate(module.intArrayFromString('--nosignals'), 'i8', module.ALLOC_NORMAL)
                ];
                const argvPtr = module._malloc(argvArray.length * 4);
                for (let i = 0; i < argvArray.length; i++) {
                    module.setValue(argvPtr + i * 4, argvArray[i], '*');
                }
                if (!bindings.PL_initialise(4, argvPtr)) {
                    throw new Error('SWI-Prolog initialisation failed.');
                }
                // Set the path of the preloaded (from swipl-web.dat) standard library.
                // This makes it possible to call use_module(library(lists)) and so on.
                call(bindings, "assert(user:file_search_path(library, 'wasm-preload/library')).");
            };

           (async () => {
           	const swipl = Swipl({
	           			arguments:['swipl','-x', 'wasm-preload/boot.prc', '--nosignals'],
	           			print: print,
	                printErr: printErr,
	           			preRun: [module => module.FS.init(readStdin)],

	           		}).then(module => {

		           		console.log({module})

		           		 bindings = createBindings(module);
                    // Initialise SWI-Prolog.
                    initialise(bindings, module);

                                window.query = (input) => {
	            	module.FS.writeFile('/file.pl',input + '\n');
                callQuery(bindings, "consult('/file.pl').");
              }

           	});
		       // End the async Immediately Invoked Function Expression
           })();
    
        const observer_config = { 
                attributes: true, 
                childList: true, 
                subtree: true, 
                characterData: true 
            }               
        const observer = new MutationObserver(
										            (mutationList,observer) => console.log(mutationList)
									           ).observe(window.document, observer_config)

        </script>

        <style>
            html {
                padding:40px;
                font-family:monospace;
                filter:invert(1);
                background:black;
            }    
            body {
                white-space:pre-wrap;
            }/style>
    </head>

    <body contenteditable>


        :- use_module(library(lists)).

        %%    queens(+N, -Queens) is nondet.
        %
        %   @param  Queens is a list of column numbers for placing the queens.
        %   @author Richard A. O'Keefe (The Craft of Prolog)

        queens(N, Queens) :-
            length(Queens, N),
            board(Queens, Board, 0, N, _, _),
            queens(Board, 0, Queens).

        board([], [], N, N, _, _).
        board([_|Queens], [Col-Vars|Board], Col0, N, [_|VR], VC) :-
            Col is Col0+1,
            functor(Vars, f, N),
            constraints(N, Vars, VR, VC),
            board(Queens, Board, Col, N, VR, [_|VC]).

        constraints(0, _, _, _) :- !.
        constraints(N, Row, [R|Rs], [C|Cs]) :-
            arg(N, Row, R-C),
            M is N-1,
            constraints(M, Row, Rs, Cs).

        queens([], _, []).
        queens([C|Cs], Row0, [Col|Solution]) :-
            Row is Row0+1,
            select(Col-Vars, [C|Cs], Board),
            arg(Row, Vars, Row-Row),
            queens(Board, Row, Solution).
    </body>
</html>
